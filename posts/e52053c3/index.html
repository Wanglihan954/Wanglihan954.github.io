<!DOCTYPE html><html lang="zh-CN"><head><!-- hexo injector head_begin start --><link href="https://fastly.jsdelivr.net/npm/hexo-tag-common@0.2.0/css/index.css" rel="stylesheet"/><!-- hexo injector head_begin end --><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="å®ç¿°"><meta name="copyright" content="å®ç¿°"><meta name="generator" content="Hexo 8.1.1"><meta name="theme" content="hexo-theme-yun"><title>Lesson 5 | å®ç¿°ã®HEXO</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script defer src="https://fastly.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><link rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.css"><script defer src="https://fastly.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><script defer src="https://fastly.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"></script><script type="module">import { renderKatex } from '/js/utils.js'
document.addEventListener("DOMContentLoaded", () => {
  renderKatex({
    ...{"renderMathInElement":true,"strict":"ignore","output":"htmlAndMathml","displayMode":true,"trust":true},
    ...undefined?.options,
  });
});</script><link rel="icon" type="image/png" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"20020730.xyz","root":"/","title":"è®©æ¢¦æˆä¸ºå¯èƒ½","version":"1.10.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"æœç´¢...","empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹: ${query}","hits":"æ‰¾åˆ° ${hits} æ¡ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]},"waline":{"config":{"enable":true,"serverURL":"https://waline2333-ten.vercel.app","comment":true,"visitor":true,"el":"#waline","lang":"zh-CN"},"cdn":"https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.js","dark":"html.dark"},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="å®ç¿°ã®HEXO" type="application/atom+xml"><meta name="description" content="ç¬¬ 5 è¯¾ ç®—å­å’Œç®—å­æ³¨å†Œå™¨çš„è®¾è®¡ä¸å®ç°è®¡ç®—èŠ‚ç‚¹åœ¨æˆ‘ä»¬è¿™ä¸ªé¡¹ç›®ä¸­è¢«ç§°ä¹‹ä¸ºRuntimeOperator, å…·ä½“çš„ç»“æ„å®šä¹‰å¦‚ä¸‹çš„ä»£ç æ‰€ç¤ºï¼š 12345678910111213141516struct RuntimeOperator &#123;  virtual ~RuntimeOperator();  bool has_forward &#x3D; false;  std::string name;">
<meta property="og:type" content="article">
<meta property="og:title" content="Lesson 5">
<meta property="og:url" content="https://20020730.xyz/posts/e52053c3/index.html">
<meta property="og:site_name" content="å®ç¿°ã®HEXO">
<meta property="og:description" content="ç¬¬ 5 è¯¾ ç®—å­å’Œç®—å­æ³¨å†Œå™¨çš„è®¾è®¡ä¸å®ç°è®¡ç®—èŠ‚ç‚¹åœ¨æˆ‘ä»¬è¿™ä¸ªé¡¹ç›®ä¸­è¢«ç§°ä¹‹ä¸ºRuntimeOperator, å…·ä½“çš„ç»“æ„å®šä¹‰å¦‚ä¸‹çš„ä»£ç æ‰€ç¤ºï¼š 12345678910111213141516struct RuntimeOperator &#123;  virtual ~RuntimeOperator();  bool has_forward &#x3D; false;  std::string name;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic3.zhimg.com/v2-433386066b3772bf92bc28a529267cca_1440w.jpg">
<meta property="og:image" content="https://pic1.zhimg.com/v2-fc6adefcb609228ffa98eb0b97538610_1440w.jpg">
<meta property="og:image" content="https://pic1.zhimg.com/v2-fc6adefcb609228ffa98eb0b97538610_1440w.jpg">
<meta property="article:published_time" content="2025-12-03T12:00:39.000Z">
<meta property="article:modified_time" content="2025-12-11T04:26:32.346Z">
<meta property="article:author" content="å®ç¿°">
<meta property="article:tag" content="C#">
<meta property="article:tag" content="DeepLearning">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic3.zhimg.com/v2-433386066b3772bf92bc28a529267cca_1440w.jpg"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="æ–‡ç« ç›®å½•"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="ç«™ç‚¹æ¦‚è§ˆ"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="å®ç¿°"><img width="96" loading="lazy" src="/images/funingna.png" alt="å®ç¿°"><span class="site-author-status" title="å››å­£èŠ±å¼€">ğŸ‘</span></a><div class="site-author-name"><a href="/about/">å®ç¿°</a></div><span class="site-name">å®ç¿°ã®HEXO</span><sub class="site-subtitle">æˆ‘çš„ä¸–ç•Œ</sub><div class="site-description">è¸ç€æ¢¦èµ°è¿‡æ—¶å…‰</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="é¦–é¡µ"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="å½’æ¡£"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">8</span></a></div><div class="site-state-item"><a href="/categories/" title="åˆ†ç±»"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">2</span></a></div><div class="site-state-item"><a href="/tags/" title="æ ‡ç­¾"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">7</span></a></div><div class="site-state-item"><a href="/about/"><span class="site-state-item-icon"><i class="fas fa-user-circle"></i></span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="æ–‡æ¡£"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><span class="icon iconify" data-icon="ri:rss-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/Wanglihan954" title="GitHub" target="_blank" style="color:#181717"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:admin@yemengstar.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=1485292158" title="ç½‘æ˜“äº‘éŸ³ä¹" target="_blank" style="color:#C10D0C"><span class="icon iconify" data-icon="ri:netease-cloud-music-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://y.qq.com/n/ryqq/msg_center" title="QQéŸ³ä¹" target="_blank" style="color:#10A983"><span class="icon iconify" data-icon="ri:qq-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/xiao-wang-52-36-47" title="çŸ¥ä¹" target="_blank" style="color:#0084FF"><span class="icon iconify" data-icon="ri:zhihu-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/435092993" title="å“”å“©å“”å“©" target="_blank" style="color:#FF8EB3"><span class="icon iconify" data-icon="ri:bilibili-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="æˆ‘çš„å°ä¼™ä¼´ä»¬" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a><a class="links-item hty-icon-button" href="/girls/" title="å¥¹ä»¬éƒ½æ˜¯æˆ‘çš„ç¿…è†€" style="color:#FF69B4"><span class="icon iconify" data-icon="ri:women-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC-5-%E8%AF%BE-%E7%AE%97%E5%AD%90%E5%92%8C%E7%AE%97%E5%AD%90%E6%B3%A8%E5%86%8C%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text">ç¬¬ 5 è¯¾ ç®—å­å’Œç®—å­æ³¨å†Œå™¨çš„è®¾è®¡ä¸å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Layer%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.</span> <span class="toc-text">Layerç±»å‹çš„å®šä¹‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E7%9A%84%E7%AE%97%E5%AD%90%E6%B3%A8%E5%86%8C%E5%99%A8"><span class="toc-number">1.2.</span> <span class="toc-text">å…¨å±€çš„ç®—å­æ³¨å†Œå™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E7%AE%97%E5%AD%90%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">æ³¨å†Œç®—å­çš„è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E6%B3%A8%E5%86%8C%E5%99%A8%E4%B8%AD%E5%8F%96%E5%87%BA%E7%AE%97%E5%AD%90"><span class="toc-number">1.4.</span> <span class="toc-text">ä»æ³¨å†Œå™¨ä¸­å–å‡ºç®—å­</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BA%86%E6%9B%B4%E6%96%B9%E4%BE%BF%E5%9C%B0%E6%B3%A8%E5%86%8C%E7%AE%97%E5%AD%90"><span class="toc-number">1.5.</span> <span class="toc-text">ä¸ºäº†æ›´æ–¹ä¾¿åœ°æ³¨å†Œç®—å­</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%AE%97%E5%AD%90-ReLU"><span class="toc-number">1.6.</span> <span class="toc-text">åˆ›å»ºç¬¬ä¸€ä¸ªç®—å­ ReLU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReLU%E7%AE%97%E5%AD%90%E7%9A%84%E6%B3%A8%E5%86%8C"><span class="toc-number">1.7.</span> <span class="toc-text">ReLUç®—å­çš„æ³¨å†Œ</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="https://20020730.xyz/posts/e52053c3/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="å®ç¿°"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="å®ç¿°ã®HEXO"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Lesson 5</h1><div class="post-meta"><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="æœ¬æ–‡å­—æ•°"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="æœ¬æ–‡å­—æ•°">3.5k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="é˜…è¯»æ—¶é•¿"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="é˜…è¯»æ—¶é•¿">14m</span></span></span><span class="leancloud_visitors" id="/posts/e52053c3/" data-flag-title="Lesson 5"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="é˜…è¯»æ¬¡æ•°"><span class="icon iconify" data-icon="ri:eye-line"></span> <span class="leancloud-visitors-count"></span></span></span><span class="post-meta-divider">-</span><a href="#comment"><span class="post-meta-item-icon" title="è¯„è®ºæ•°"><span class="icon iconify" data-icon="ri:chat-3-line"></span> <span class="waline-comment-count" id="/posts/e52053c3/"></span></span></a><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/KuiperInfer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">KuiperInferå­¦ä¹ ç¬”è®°</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/C/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">C#</span></a><a class="tag-item" href="/tags/DeepLearning/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">DeepLearning</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h1 id="ç¬¬-5-è¯¾-ç®—å­å’Œç®—å­æ³¨å†Œå™¨çš„è®¾è®¡ä¸å®ç°"><a href="#ç¬¬-5-è¯¾-ç®—å­å’Œç®—å­æ³¨å†Œå™¨çš„è®¾è®¡ä¸å®ç°" class="headerlink" title="ç¬¬ 5 è¯¾ ç®—å­å’Œç®—å­æ³¨å†Œå™¨çš„è®¾è®¡ä¸å®ç°"></a>ç¬¬ 5 è¯¾ ç®—å­å’Œç®—å­æ³¨å†Œå™¨çš„è®¾è®¡ä¸å®ç°</h1><p>è®¡ç®—èŠ‚ç‚¹åœ¨æˆ‘ä»¬è¿™ä¸ªé¡¹ç›®ä¸­è¢«ç§°ä¹‹ä¸º<code>RuntimeOperator</code>, å…·ä½“çš„ç»“æ„å®šä¹‰å¦‚ä¸‹çš„ä»£ç æ‰€ç¤ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">RuntimeOperator</span> &#123;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">RuntimeOperator</span>();</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> has_forward = <span class="literal">false</span>;</span><br><span class="line">  std::string name;      <span class="comment">/// è®¡ç®—èŠ‚ç‚¹çš„åç§°</span></span><br><span class="line">  std::string type;      <span class="comment">/// è®¡ç®—èŠ‚ç‚¹çš„ç±»å‹</span></span><br><span class="line">  std::shared_ptr&lt;Layer&gt; layer;  <span class="comment">/// èŠ‚ç‚¹å¯¹åº”çš„è®¡ç®—Layer</span></span><br><span class="line"></span><br><span class="line">  std::map&lt;std::string, std::shared_ptr&lt;RuntimeOperand&gt;&gt;</span><br><span class="line">      input_operands;  <span class="comment">/// èŠ‚ç‚¹çš„è¾“å…¥æ“ä½œæ•°</span></span><br><span class="line">  std::shared_ptr&lt;RuntimeOperand&gt; output_operands;  <span class="comment">/// èŠ‚ç‚¹çš„è¾“å‡ºæ“ä½œæ•°</span></span><br><span class="line">  std::vector&lt;std::shared_ptr&lt;RuntimeOperand&gt;&gt;</span><br><span class="line">      input_operands_seq;  <span class="comment">/// èŠ‚ç‚¹çš„è¾“å…¥æ“ä½œæ•°ï¼Œé¡ºåºæ’åˆ—</span></span><br><span class="line">  std::map&lt;std::string, std::shared_ptr&lt;RuntimeOperator&gt;&gt;</span><br><span class="line">      output_operators;  <span class="comment">/// è¾“å‡ºèŠ‚ç‚¹çš„åå­—å’ŒèŠ‚ç‚¹å¯¹åº”</span></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹(<code>RuntimeOperator</code>)ä¸­ï¼Œæˆ‘ä»¬è®°å½•äº†ä¸è¯¥èŠ‚ç‚¹ç›¸å…³çš„ç±»å‹ã€åç§°ï¼Œä»¥åŠè¾“å…¥è¾“å‡ºæ•°ç­‰ä¿¡æ¯ã€‚å…¶ä¸­æœ€é‡è¦çš„æ˜¯<code>layer</code>å˜é‡ï¼Œå®ƒè¡¨ç¤ºä¸è®¡ç®—èŠ‚ç‚¹å…³è”çš„ç®—å­ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œå…·ä½“è®¡ç®—çš„å®æ–½è€…ã€‚</p>
<p>é€šè¿‡è®¿é—®<code>RuntimeOperator</code>çš„è¾“å…¥æ•°(<code>input_operand</code>)ï¼Œ<code>layer</code>å¯ä»¥è·å–è®¡ç®—æ‰€éœ€çš„è¾“å…¥å¼ é‡æ•°æ®ï¼Œ<strong>å¹¶æ ¹æ®<code>layer</code>å„<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E6%B4%BE%E7%94%9F%E7%B1%BB&zhida_source=entity">æ´¾ç”Ÿç±»</a>åˆ«ä¸­å®šä¹‰çš„<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E8%AE%A1%E7%AE%97%E5%87%BD%E6%95%B0&zhida_source=entity">è®¡ç®—å‡½æ•°</a>(<code>forward</code>)å¯¹è¾“å…¥å¼ é‡æ•°æ®è¿›è¡Œè®¡ç®—</strong>ã€‚è®¡ç®—å®Œæˆåï¼Œè®¡ç®—ç»“æœå°†å­˜å‚¨åœ¨è¯¥èŠ‚ç‚¹çš„è¾“å‡ºæ•°(<code>output_operand</code>)ä¸­ã€‚</p>
<h3 id="Layerç±»å‹çš„å®šä¹‰"><a href="#Layerç±»å‹çš„å®šä¹‰" class="headerlink" title="Layerç±»å‹çš„å®šä¹‰"></a>Layerç±»å‹çš„å®šä¹‰</h3><p>ä»¥ä¸‹çš„ä»£ç ä½äº<code>include/abstract/layer.hpp</code>ä¸­ï¼Œ<strong>å®ƒæ˜¯æ‰€æœ‰ç®—å­çš„çˆ¶ç±»</strong>ï¼Œå¦‚æœè¦å®ç°é¡¹ç›®ä¸­å…¶ä»–çš„ç®—å­ï¼Œéƒ½éœ€è¦ç»§æ‰¿äºè¯¥ç±»ä½œä¸ºæ´¾ç”Ÿç±»å¹¶é‡å†™å…¶ä¸­çš„è®¡ç®—å‡½æ•°(<code>forward</code>)ï¼ŒåŒ…æ‹¬æˆ‘ä»¬è¿™èŠ‚è¯¾è¦å®ç°çš„<code>ReLU</code>ç®—å­ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Layer</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">Layer</span><span class="params">(std::string layer_name)</span> : layer_name_(std::move(layer_name)) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Layer</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Layerçš„æ‰§è¡Œå‡½æ•°</span></span><br><span class="line"><span class="comment">   * @param inputs å±‚çš„è¾“å…¥</span></span><br><span class="line"><span class="comment">   * @param outputs å±‚çš„è¾“å‡º</span></span><br><span class="line"><span class="comment">   * @return æ‰§è¡Œçš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> InferStatus <span class="title">Forward</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">const</span> std::vector&lt;std::shared_ptr&lt;Tensor&lt;<span class="type">float</span>&gt;&gt;&gt;&amp; inputs,</span></span></span><br><span class="line"><span class="params"><span class="function">      std::vector&lt;std::shared_ptr&lt;Tensor&lt;<span class="type">float</span>&gt;&gt;&gt;&amp; outputs)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Layerçš„æ‰§è¡Œå‡½æ•°</span></span><br><span class="line"><span class="comment">   * @param current_operator å½“å‰çš„operator</span></span><br><span class="line"><span class="comment">   * @return æ‰§è¡Œçš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> InferStatus <span class="title">Forward</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šçš„ä»£ç å®šä¹‰äº†<code>Layer</code>ç±»çš„<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0&zhida_source=entity">æ„é€ å‡½æ•°</a>ï¼Œå®ƒåªéœ€è¦ä¸€ä¸ª<code>layer_name</code>å˜é‡æ¥æŒ‡å®šè¯¥ç®—å­çš„åç§°ã€‚æˆ‘ä»¬é‡ç‚¹å…³æ³¨å¸¦æœ‰å‚æ•°çš„<code>Forward</code>æ–¹æ³•ï¼Œå®ƒæ˜¯ç®—å­ä¸­å®šä¹‰çš„è®¡ç®—å‡½æ•°ã€‚</p>
<p>è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯<code>inputs</code>å’Œ<code>outputs</code>ã€‚å®ƒä»¬æ˜¯åœ¨è®¡ç®—è¿‡ç¨‹ä¸­æ‰€éœ€çš„è¾“å…¥å’Œè¾“å‡ºå¼ é‡æ•°ç»„ã€‚<strong>æ¯ä¸ªç®—å­çš„æ´¾ç”Ÿç±»éƒ½éœ€è¦é‡å†™è¿™ä¸ªå¸¦å‚æ•°çš„<code>Forward</code>æ–¹æ³•ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰è®¡ç®—çš„å…·ä½“é€»è¾‘ã€‚</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Layer</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  std::weak_ptr&lt;RuntimeOperator&gt; runtime_operator_;</span><br><span class="line">  std::string layer_name_;  <span class="comment">/// Layerçš„åç§°</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨<code>Layer</code>ç±»ä¸­æœ‰ä¸¤ä¸ª<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F&zhida_source=entity">æˆå‘˜å˜é‡</a>ã€‚ä¸€ä¸ªæ˜¯åœ¨æ„é€ å‡½æ•°ä¸­æŒ‡å®šçš„ç®—å­åç§° <code>layer_name</code>ï¼Œå¦ä¸€ä¸ªæ˜¯ä¸è¯¥ç®—å­å…³è”çš„è®¡ç®—èŠ‚ç‚¹å˜é‡ <code>RuntimeOperator</code>ã€‚æˆ‘ä»¬åœ¨ä¹‹å‰å›é¡¾äº† <code>RuntimeOperator</code> çš„å®šä¹‰ï¼š</p>
<p><img src="https://pic3.zhimg.com/v2-433386066b3772bf92bc28a529267cca_1440w.jpg" alt="img" loading="lazy"></p>
<p>ä¸éš¾çœ‹å‡ºï¼Œ<code>RuntimeOperator</code>ä¸è¯¥èŠ‚ç‚¹å¯¹åº”çš„ <code>Layer</code> ç›¸å…³è”ï¼Œè€Œ <code>Layer</code> ä¹Ÿå…³è”äº†å®ƒæ‰€å±çš„ <code>RuntimeOperator</code>ï¼Œå› æ­¤å®ƒä»¬ä¹‹é—´æ˜¯<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E5%8F%8C%E5%90%91%E5%85%B3%E8%81%94&zhida_source=entity">åŒå‘å…³è”</a>çš„å…³ç³»ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ <code>Layer</code> ç±»ä¸­ä¸å¸¦å‚æ•°çš„ <code>Forward</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯æ‰€æœ‰ç®—å­çš„<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E7%88%B6%E7%B1%BB%E6%96%B9%E6%B3%95&zhida_source=entity">çˆ¶ç±»æ–¹æ³•</a>ï¼Œ<strong>å®ƒçš„ä½œç”¨æ˜¯å‡†å¤‡è¾“å…¥å’Œè¾“å‡ºæ•°æ®ï¼Œå¹¶ä½¿ç”¨è¿™äº›æ•°æ®è°ƒç”¨æ¯ä¸ªæ´¾ç”Ÿç±»ç®—å­ä¸­å„è‡ªå®ç°çš„è®¡ç®—è¿‡ç¨‹</strong>ï¼ˆä¸Šæ–‡æåˆ°çš„å¸¦å‚æ•°çš„ <code>Forward</code> å‡½æ•°ï¼‰ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">InferStatus <span class="title">Layer::Forward</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">LOG_IF</span>(FATAL, <span class="keyword">this</span>-&gt;runtime_operator_.<span class="built_in">expired</span>())</span><br><span class="line">      &lt;&lt; <span class="string">&quot;Runtime operator is expired or nullptr&quot;</span>;</span><br><span class="line">  <span class="comment">// è·å–ç®—å­ç›¸å…³çš„è®¡ç®—èŠ‚ç‚¹</span></span><br><span class="line">  <span class="type">const</span> <span class="keyword">auto</span>&amp; runtime_operator = <span class="keyword">this</span>-&gt;runtime_operator_.<span class="built_in">lock</span>();</span><br><span class="line">  <span class="comment">// å‡†å¤‡èŠ‚ç‚¹layerè®¡ç®—æ‰€éœ€è¦çš„è¾“å…¥</span></span><br><span class="line">  <span class="type">const</span> std::vector&lt;std::shared_ptr&lt;RuntimeOperand&gt;&gt;&amp; input_operand_datas = runtime_operator-&gt;input_operands_seq;</span><br><span class="line">  <span class="comment">// layerçš„è¾“å…¥</span></span><br><span class="line">  std::vector&lt;std::shared_ptr&lt;Tensor&lt;<span class="type">float</span>&gt;&gt;&gt; layer_input_datas;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; input_operand_data : input_operand_datas) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; input_data : input_operand_data-&gt;datas) &#123;</span><br><span class="line">      layer_input_datas.<span class="built_in">push_back</span>(input_data);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>Layer</code>ç±»çš„ä¸å¸¦å‚æ•°çš„<code>Forward</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè·å–ä¸è¯¥<code>Layer</code>ç›¸å¯¹åº”çš„è®¡ç®—èŠ‚ç‚¹<code>RuntimeOperator</code>ã€‚å®ƒä»¬ä¹‹é—´æ˜¯åŒå‘å…³è”çš„å…³ç³»ï¼Œä¸€ä¸ªç®—å­å¯¹åº”ä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹(<code>RuntimeOperator</code>ï¼‰ï¼Œä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªç®—å­(<code>Layer</code>)ã€‚</p>
<p>æˆ‘ä»¬ä»è®¡ç®—èŠ‚ç‚¹ä¸­å¾—åˆ°<strong>è¯¥èŠ‚ç‚¹å¯¹åº”çš„è¾“å…¥æ•°</strong><code>input_operand_datas</code>ä»¥åŠ<strong>è¯¥è¾“å…¥æ•°å­˜å‚¨çš„å¼ é‡æ•°æ®</strong><code>layer_input_datas</code>. éšåï¼Œæˆ‘ä»¬å†ä»è®¡ç®—èŠ‚ç‚¹ä¸­å–å‡ºå¯¹åº”çš„è¾“å‡ºæ•°<code>output_operand_datas</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> std::shared_ptr&lt;RuntimeOperand&gt;&amp; output_operand_datas =</span><br><span class="line">      runtime_operator-&gt;output_operands;</span><br><span class="line">  InferStatus status = runtime_operator-&gt;layer-&gt;<span class="built_in">Forward</span>(</span><br><span class="line">      layer_input_datas, output_operand_datas-&gt;datas);</span><br></pre></td></tr></table></figure>

<p>åœ¨ä»¥ä¸Šçš„æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬ä»è®¡ç®—èŠ‚ç‚¹<code>RuntimeOperator</code>ä¸­è·å–äº†ç›¸å…³çš„è¾“å…¥æ•°å’Œè¾“å‡ºæ•°ï¼Œéšåæˆ‘ä»¬å†ä½¿ç”¨å¯¹åº”çš„è¾“å…¥å’Œè¾“å‡ºå¼ é‡<strong>å»è°ƒç”¨å­ç±»ç®—å­å„è‡ªå®ç°çš„ï¼Œå¸¦å‚æ•°çš„<code>Forward</code>å‡½æ•°</strong>ã€‚</p>
<p><img src="https://pic1.zhimg.com/v2-fc6adefcb609228ffa98eb0b97538610_1440w.jpg" alt="img" loading="lazy"></p>
<h3 id="å…¨å±€çš„ç®—å­æ³¨å†Œå™¨"><a href="#å…¨å±€çš„ç®—å­æ³¨å†Œå™¨" class="headerlink" title="å…¨å±€çš„ç®—å­æ³¨å†Œå™¨"></a>å…¨å±€çš„ç®—å­æ³¨å†Œå™¨</h3><p>åœ¨<code>KuiperInfer</code>ä¸­ç®—å­æ³¨å†Œæœºåˆ¶ä½¿ç”¨äº†<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F&zhida_source=entity">å•ä¾‹æ¨¡å¼</a>å’Œå·¥å‚æ¨¡å¼ã€‚é¦–å…ˆï¼Œåœ¨å…¨å±€èŒƒå›´å†…åˆ›å»ºä¸€ä¸ª&#x3D;&#x3D;<strong>å”¯ä¸€</strong>&#x3D;&#x3D;çš„æ³¨å†Œè¡¨<code>registry</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ª<code>map</code>ç±»å‹çš„å¯¹è±¡ã€‚<strong>è¿™ä¸ªæ³¨å†Œè¡¨çš„é”®æ˜¯ç®—å­çš„ç±»å‹ï¼Œè€Œå€¼æ˜¯ç®—å­çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚</strong></p>
<p><a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E5%BC%80%E5%8F%91%E8%80%85&zhida_source=entity">å¼€å‘è€…</a>å®Œæˆä¸€ä¸ªç®—å­çš„å¼€å‘åï¼Œéœ€è¦é€šè¿‡ç‰¹å®šçš„æ³¨å†Œæœºåˆ¶å°†ç®—å­å†™å…¥å…¨å±€æ³¨å†Œè¡¨ä¸­ã€‚è¿™å¯ä»¥é€šè¿‡åœ¨æ³¨å†Œè¡¨ä¸­æ·»åŠ é”®å€¼å¯¹æ¥å®ç°ã€‚ç®—å­çš„ç±»å‹ä½œä¸ºé”®ï¼Œç®—å­çš„åˆå§‹åŒ–è¿‡ç¨‹ä½œä¸ºå€¼ã€‚è¿™æ ·ï¼Œå½“éœ€è¦ä½¿ç”¨æŸä¸ªç®—å­æ—¶ï¼Œå¯ä»¥æ ¹æ®ç®—å­çš„ç±»å‹ä»å…¨å±€æ³¨å†Œè¡¨ä¸­æ–¹ä¾¿åœ°è·å–å¯¹åº”çš„ç®—å­ã€‚</p>
<p>åœ¨å®ç°ä¸Šå•ä¾‹æ¨¡å¼ç¡®ä¿äº†åªæœ‰ä¸€ä¸ªå…¨å±€<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=6&q=%E6%B3%A8%E5%86%8C%E8%A1%A8&zhida_source=entity">æ³¨å†Œè¡¨</a>å®ä¾‹ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä»£ç çš„ä»»ä½•åœ°æ–¹è®¿é—®è¯¥æ³¨å†Œè¡¨ã€‚<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=2&q=%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F&zhida_source=entity">å·¥å‚æ¨¡å¼</a>åˆ™è´Ÿè´£æ ¹æ®ç®—å­çš„ç±»å‹è¿”å›ç›¸åº”çš„ç®—å­å®ä¾‹ã€‚è¿™ç§æ³¨å†Œæœºåˆ¶çš„è®¾è®¡ä½¿å¾—æ¨ç†æ¡†æ¶èƒ½å¤Ÿæ„ŸçŸ¥åˆ°å¼€å‘è€…å·²ç»å®ç°çš„ç®—å­ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ–¹ä¾¿åœ°è°ƒç”¨å’Œä½¿ç”¨è¿™äº›ç®—å­ã€‚</p>
<table>
<thead>
<tr>
<th>ç®—å­ç±»å‹</th>
<th>åˆå§‹åŒ–è¿‡ç¨‹</th>
</tr>
</thead>
<tbody><tr>
<td>Conv</td>
<td>ConvInstance</td>
</tr>
<tr>
<td>ReLU</td>
<td>ReLUInstance</td>
</tr>
</tbody></table>
<p>å½“æ‰€æœ‰æ”¯æŒçš„ç®—å­éƒ½è¢«æ·»åŠ åˆ°æ³¨å†Œè¡¨ä¸­åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>registry.find(layer_type)</code>æ¥è·å–ç‰¹å®šç±»å‹ç®—å­çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¹¶é€šè¿‡è¯¥åˆå§‹åŒ–è¿‡ç¨‹è·å–ç›¸åº”ç®—å­çš„å®ä¾‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LayerRegisterer</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">typedef</span> <span class="title">ParseParameterAttrStatus</span> <span class="params">(*Creator)</span></span></span><br><span class="line"><span class="function">      <span class="params">(<span class="type">const</span> std::shared_ptr&lt;RuntimeOperator&gt; &amp;op, std::shared_ptr&lt;Layer&gt; &amp;layer)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">typedef</span> std::map&lt;std::string, Creator&gt; CreateRegistry;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * å‘æ³¨å†Œè¡¨æ³¨å†Œç®—å­</span></span><br><span class="line"><span class="comment">   * @param layer_type ç®—å­çš„ç±»å‹</span></span><br><span class="line"><span class="comment">   * @param creator éœ€è¦æ³¨å†Œç®—å­çš„æ³¨å†Œè¡¨</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">RegisterCreator</span><span class="params">(<span class="type">const</span> std::string &amp;layer_type, <span class="type">const</span> Creator &amp;creator)</span></span>;</span><br><span class="line">  ....</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç ä¸­çš„<code>creator</code>æ˜¯ä¸€ä¸ª<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88&zhida_source=entity">å‡½æ•°æŒ‡é’ˆ</a>ï¼ŒæŒ‡å‘æŸä¸€ç±»ç®—å­çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œä¸åŒçš„ç®—å­å…·æœ‰ä¸åŒçš„<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%87%BD%E6%95%B0&zhida_source=entity">å®ä¾‹åŒ–å‡½æ•°</a>ï¼Œä½†æ˜¯éƒ½éœ€è¦ç¬¦åˆè¦æ±‚ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ParseParameterAttrStatus</span> <span class="params">(*Creator)</span></span></span><br><span class="line"><span class="function">      <span class="params">(<span class="type">const</span> std::shared_ptr&lt;RuntimeOperator&gt; &amp;op,std::shared_ptr&lt;Layer&gt; &amp;layer)</span></span>;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä»¥ä¸Šå†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°<strong>ä¸åŒçš„ç®—å­å®ä¾‹åŒ–å‡½æ•°éƒ½éœ€è¦æ¥å—ä¸¤ä¸ªå‚æ•°</strong>ï¼š<code>RuntimeOperator</code>å’Œå¾…åˆå§‹åŒ–çš„ç®—å­<code>layer</code>ã€‚è¿™äº›å‡½æ•°ä¼šè¿”å›ä¸€ä¸ª<code>ParseParameterAttrStatus</code>ç±»å‹çš„çŠ¶æ€å€¼ã€‚</p>
<p>æ¢å¥è¯è¯´ï¼Œè¿™é‡Œçš„<code>Creator</code>æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹ï¼Œç”¨äºå®šä¹‰æŸä¸ªç±»å‹ç®—å­çš„åˆ›å»ºè¿‡ç¨‹ã€‚å½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨æŸä¸ªç±»å‹çš„ç®—å­æ—¶ï¼Œå¯ä»¥ä»<code>CreateRegistry</code>ç±»å‹çš„æ³¨å†Œè¡¨ä¸­è·å–è¯¥ç®—å­çš„åˆ›å»ºè¿‡ç¨‹ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬å°†ç›¸åº”çš„<code>RuntimeOperator</code>å’Œå¾…åˆå§‹åŒ–çš„<code>Layer</code>ä¼ é€’ç»™åˆ›å»ºè¿‡ç¨‹ï¼Œå®Œæˆåˆå§‹åŒ–å¹¶è·å¾—å®ä¾‹åŒ–åçš„ç®—å­ã€‚</p>
<h3 id="æ³¨å†Œç®—å­çš„è¿‡ç¨‹"><a href="#æ³¨å†Œç®—å­çš„è¿‡ç¨‹" class="headerlink" title="æ³¨å†Œç®—å­çš„è¿‡ç¨‹"></a>æ³¨å†Œç®—å­çš„è¿‡ç¨‹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LayerRegisterer::CreateRegistry&amp; <span class="title">LayerRegisterer::Registry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">static</span> CreateRegistry* kRegistry = <span class="keyword">new</span> <span class="built_in">CreateRegistry</span>();</span><br><span class="line">  <span class="built_in">CHECK</span>(kRegistry != <span class="literal">nullptr</span>) &lt;&lt; <span class="string">&quot;Global layer register init failed!&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> *kRegistry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LayerRegisterer::RegisterCreator</span><span class="params">(<span class="type">const</span> std::string &amp;layer_type,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="type">const</span> Creator &amp;creator)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">CHECK</span>(creator != <span class="literal">nullptr</span>);</span><br><span class="line">  CreateRegistry &amp;registry = <span class="built_in">Registry</span>();</span><br><span class="line">  <span class="built_in">CHECK_EQ</span>(registry.<span class="built_in">count</span>(layer_type), <span class="number">0</span>)</span><br><span class="line">      &lt;&lt; <span class="string">&quot;Layer type: &quot;</span> &lt;&lt; layer_type &lt;&lt; <span class="string">&quot; has already registered!&quot;</span>;</span><br><span class="line">  registry.<span class="built_in">insert</span>(&#123;layer_type, creator&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LayerRegisterer::CreateRegistry &amp;<span class="title">LayerRegisterer::Registry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">static</span> CreateRegistry *kRegistry = <span class="keyword">new</span> <span class="built_in">CreateRegistry</span>();</span><br><span class="line">  <span class="built_in">CHECK</span>(kRegistry != <span class="literal">nullptr</span>) &lt;&lt; <span class="string">&quot;Global layer register init failed!&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> *kRegistry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>Registry</code>å‡½æ•°ã€‚è¿™é‡Œä½¿ç”¨äº†<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8&zhida_source=entity">çº¿ç¨‹å®‰å…¨</a>çš„æ‡’æ±‰å¼ä»£ç å®ç°ï¼Œå¹¶ä¸”åˆ©ç”¨äº†<code>C++11</code>æ ‡å‡†ä¸­çš„**Magic Staticï¼ˆ<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E5%B1%80%E9%83%A8%E9%9D%99%E6%80%81%E5%8F%98%E9%87%8F&zhida_source=entity">å±€éƒ¨é™æ€å˜é‡</a>ï¼‰**ç‰¹æ€§ã€‚åœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œå…¨å±€æ³¨å†Œè¡¨<code>registry</code>å˜é‡æ˜¯ä¸€ä¸ªå”¯ä¸€çš„å®ä¾‹<code>kRegistry</code>ï¼Œæ— è®ºè¯¥å‡½æ•°è¢«è°ƒç”¨å¤šå°‘æ¬¡ï¼Œéƒ½ä¼šè¿”å›åŒä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p>ç„¶åï¼Œå›åˆ°æ³¨å†Œå‡½æ•°<code>RegisterCreator</code>ã€‚è¿™ä¸ªå‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šç®—å­çš„ç±»å‹<code>layer_type</code>å’Œ<code>Creator</code>ç±»å‹ã€‚æ­£å¦‚å‰é¢æ‰€è¿°ï¼Œ<code>creator</code>å‚æ•°æ˜¯è¯¥ç±»ç®—å­çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚</p>
<p>åœ¨<code>RegistryCreator</code>å‡½æ•°ä¸­ï¼Œé¦–å…ˆè·å–å…¨å±€æ³¨å†Œè¡¨<code>registry</code>ï¼Œç„¶åæ£€æŸ¥è¯¥ç±»å‹çš„ç®—å­æ˜¯å¦å·²ç»è¢«æ³¨å†Œè¿‡ã€‚å¦‚æœæ²¡æœ‰è¢«æ³¨å†Œè¿‡ï¼Œåˆ™ä½¿ç”¨<code>.insert</code>å°†å…¶æ’å…¥åˆ°å…¨å±€æ³¨å†Œè¡¨ã€‚</p>
<h3 id="ä»æ³¨å†Œå™¨ä¸­å–å‡ºç®—å­"><a href="#ä»æ³¨å†Œå™¨ä¸­å–å‡ºç®—å­" class="headerlink" title="ä»æ³¨å†Œå™¨ä¸­å–å‡ºç®—å­"></a>ä»æ³¨å†Œå™¨ä¸­å–å‡ºç®—å­</h3><p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨æ³¨å†Œè¡¨ä¸­å·²ç»æ³¨å†Œè¿‡çš„åˆ›å»ºè¿‡ç¨‹æ¥å®ä¾‹åŒ–ä¸€ä¸ªç®—å­ã€‚å…·ä½“çš„è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;Layer&gt; <span class="title">LayerRegisterer::CreateLayer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::shared_ptr&lt;RuntimeOperator&gt; &amp;op)</span> </span>&#123;</span><br><span class="line">  CreateRegistry &amp;registry = <span class="built_in">Registry</span>();</span><br><span class="line">  <span class="type">const</span> std::string &amp;layer_type = op-&gt;type;</span><br><span class="line">  <span class="built_in">LOG_IF</span>(FATAL, registry.<span class="built_in">count</span>(layer_type) &lt;= <span class="number">0</span>)</span><br><span class="line">      &lt;&lt; <span class="string">&quot;Can not find the layer type: &quot;</span> &lt;&lt; layer_type;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">auto</span> &amp;creator = registry.<span class="built_in">find</span>(layer_type)-&gt;second;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">LOG_IF</span>(FATAL, !creator) &lt;&lt; <span class="string">&quot;Layer creator is empty!&quot;</span>;</span><br><span class="line">  std::shared_ptr&lt;Layer&gt; layer;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">auto</span> &amp;status = <span class="built_in">creator</span>(op, layer);</span><br><span class="line">  <span class="built_in">LOG_IF</span>(FATAL, status != ParseParameterAttrStatus::kParameterAttrParseSuccess)</span><br><span class="line">      &lt;&lt; <span class="string">&quot;Create the layer: &quot;</span> &lt;&lt; layer_type</span><br><span class="line">      &lt;&lt; <span class="string">&quot; failed, error code: &quot;</span> &lt;&lt; <span class="built_in">int</span>(status);</span><br><span class="line">  <span class="keyword">return</span> layer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°<code>CreateLayer</code>ç”¨äºåˆ›å»ºç®—å­ï¼Œå®ƒæ¥å—ä¸€ä¸ªåä¸º<code>RuntimeOperator</code>çš„å‚æ•°ä½œä¸ºè¾“å…¥ï¼Œè¯¥å‚æ•°åŒ…å«äº†åˆ›å»ºç®—å­æ‰€éœ€çš„æ‰€æœ‰æƒé‡å’Œå‚æ•°ä¿¡æ¯ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CreateRegistry &amp;registry = <span class="built_in">Registry</span>();</span><br><span class="line">  <span class="type">const</span> std::string &amp;layer_type = op-&gt;type;</span><br><span class="line">  <span class="built_in">LOG_IF</span>(FATAL, registry.<span class="built_in">count</span>(layer_type) &lt;= <span class="number">0</span>)</span><br><span class="line">      &lt;&lt; <span class="string">&quot;Can not find the layer type: &quot;</span> &lt;&lt; layer_type;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä»¥ä¸Šçš„ä»£ç ä¸­å…ˆè·å¾—å…¨å±€æ³¨å†Œè¡¨<code>registry</code>ï¼Œå†æ£€æŸ¥è¿™ä¸ªç®—å­ç±»å‹<code>layer_type</code>æ˜¯å¦å·²ç»è¢«æ³¨å†Œåˆ°å…¨å±€æ³¨å†Œè¡¨ä¸­ï¼Œå¦‚æœå·²ç»è¢«æ³¨å†Œè¿‡ï¼Œåˆ™è·å–åˆ°è¯¥ç®—å­ç±»å‹å¯¹åº”çš„åˆ›å»ºè¿‡ç¨‹<code>creator</code>.</p>
<p>åœ¨å‰æ–‡ä¸­ï¼Œæˆ‘ä»¬è¯´è¿‡<code>creator</code>æ˜¯ä¸€ä¸ªç®—å­çš„åˆ›å»ºè¿‡ç¨‹å‡½æ•°ï¼Œ<strong>å®ƒçš„ä¼ å…¥å‚æ•°ä¸ºåŒ…å«æ‰€æœ‰å‚æ•°å’Œæƒé‡ç­‰ä¿¡æ¯çš„<code>RuntimeOperator</code>ä»¥åŠä¸€ä¸ªå¾…åˆå§‹åŒ–çš„ç®—å­<code>layer</code>.</strong> å›åˆ°<code>CreateLayer</code>å‡½æ•°ï¼Œå½“<code>creator</code>å‡½æ•°æŒ‡é’ˆè¢«è°ƒç”¨ä¹‹åå¦‚æœè¿”å›çŠ¶æ€<code>status</code>ä¸ä¸º<code>succcess</code>, è¯´æ˜åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä¸€å®šçš„é”™è¯¯ï¼Œç®—å­åˆå§‹åŒ–å¤±è´¥ï¼Œéœ€è¦å†æ’æŸ¥ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹ä¸Šé¢çš„æ•´ä½“è¿‡ç¨‹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªè®¡ç®—è¿‡ç¨‹ç±»å‹<code>Creator</code>å’Œç®—å­ç±»å‹<code>Layer</code>ã€‚ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåœ¨æ³¨å†Œè¡¨ä¸­æ³¨å†Œç®—å­çš„å‡½æ•°<code>RegisterCreator</code>ã€‚é€šè¿‡è¯¥å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¹é‡å°†ç®—å­ç±»å‹å’Œåˆ›å»ºè¿‡ç¨‹æ³¨å†Œåˆ°å…¨å±€æ³¨å†Œè¡¨ä¸­ã€‚å½“éœ€è¦ä½¿ç”¨æŸä¸ªç®—å­æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ç®—å­çš„ç±»å‹ä»å…¨å±€æ³¨å†Œè¡¨ä¸­è·å–å¯¹åº”çš„åˆ›å»ºè¿‡ç¨‹(å³<code>Creator</code>ç±»å‹çš„å‡½æ•°æŒ‡é’ˆ)ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬å°†åˆ›å»ºæ—¶æ‰€éœ€çš„å‚æ•°å’Œæƒé‡æ‰“åŒ…æˆ<code>RuntimeOperator</code>ç±»å‹ï¼Œå¹¶ä¼ é€’ç»™åˆ›å»ºè¿‡ç¨‹ï¼Œç±»ä¼¼äº<code>creator(runtime_operator)</code>ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è·å¾—ä¸€ä¸ªå®ä¾‹åŒ–åçš„ç®—å­å±‚ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±å¦‚åŒ<code>CreateLayer</code>å‡½æ•°ä¸­æ‰€ç¤ºã€‚</p>
<h3 id="ä¸ºäº†æ›´æ–¹ä¾¿åœ°æ³¨å†Œç®—å­"><a href="#ä¸ºäº†æ›´æ–¹ä¾¿åœ°æ³¨å†Œç®—å­" class="headerlink" title="ä¸ºäº†æ›´æ–¹ä¾¿åœ°æ³¨å†Œç®—å­"></a>ä¸ºäº†æ›´æ–¹ä¾¿åœ°æ³¨å†Œç®—å­</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LayerRegistererWrapper</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">LayerRegistererWrapper</span>(<span class="type">const</span> std::string &amp;layer_type, <span class="type">const</span> LayerRegisterer::Creator &amp;creator) &#123;</span><br><span class="line">    LayerRegisterer::<span class="built_in">RegisterCreator</span>(layer_type, creator);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå·¥å…·ç±»åªæœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œè¯¥æ„é€ å‡½æ•°æ¥å—ç®—å­çš„ç±»å‹å’Œè¯¥ç®—å­å¯¹åº”çš„åˆ›å»ºè¿‡ç¨‹ä½œä¸ºå‚æ•°ã€‚</p>
<p>åœ¨<code>LayerRegistererWrapper</code>ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨<code>RegisterCreator</code>æ–¹æ³•æ¥å®Œæˆå¯¹è¯¥ç®—å­åœ¨æ³¨å†Œè¡¨ä¸­çš„æ³¨å†Œã€‚å…³äº<code>RegisterCreator</code>çš„è¯¦ç»†è®²è§£ï¼Œæˆ‘ä»¬å·²ç»åœ¨å‰æ–‡æåŠè¿‡ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<h3 id="åˆ›å»ºç¬¬ä¸€ä¸ªç®—å­-ReLU"><a href="#åˆ›å»ºç¬¬ä¸€ä¸ªç®—å­-ReLU" class="headerlink" title="åˆ›å»ºç¬¬ä¸€ä¸ªç®—å­ ReLU"></a>åˆ›å»ºç¬¬ä¸€ä¸ªç®—å­ ReLU</h3><p><img src="https://pic1.zhimg.com/v2-fc6adefcb609228ffa98eb0b97538610_1440w.jpg" alt="img" loading="lazy"></p>
<p><code>ReLU</code>çš„è®¡ç®—è¿‡ç¨‹éå¸¸ç®€å•ï¼Œæœ‰å¦‚ä¸‹çš„å®šä¹‰: $ReLU(x)&#x3D;\max(0,x)$</p>
<p>æ­£å¦‚å‰æ–‡æ‰€è¿°ï¼Œä¸ºäº†å¯¹è¾“å…¥æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œ<code>ReLU</code>ç®—å­éœ€è¦å®ç°å¸¦å‚æ•°çš„å‰å‘ä¼ æ’­ï¼ˆ<code>Forwards</code>ï¼‰è¿‡ç¨‹ï¼Œå®ç°è¯¦è§<code>relu.cpp</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">InferStatus <span class="title">ReluLayer::Forward</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::vector&lt;std::shared_ptr&lt;Tensor&lt;<span class="type">float</span>&gt;&gt;&gt;&amp; inputs,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::vector&lt;std::shared_ptr&lt;Tensor&lt;<span class="type">float</span>&gt;&gt;&gt;&amp; outputs)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (inputs.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(ERROR) &lt;&lt; <span class="string">&quot;The input tensor array in the relu layer is empty&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> InferStatus::kInferFailedInputEmpty;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (inputs.<span class="built_in">size</span>() != outputs.<span class="built_in">size</span>()) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(ERROR) &lt;&lt; <span class="string">&quot;The input and output tensor array size of the relu layer do &quot;</span></span><br><span class="line">                  <span class="string">&quot;not match&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> InferStatus::kInferFailedInputOutSizeMatchError;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®å…¬å¼ å¯ä»¥çœ‹å‡ºï¼Œ<code>ReLU</code>ç®—å­ä¸ä¼šæ”¹å˜è¾“å…¥å¼ é‡çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯è¯´è¾“å…¥å’Œè¾“å‡ºå¼ é‡çš„ç»´åº¦åº”è¯¥æ˜¯ç›¸åŒçš„ã€‚å› æ­¤ï¼Œ<strong>ä¸Šè¿°ä»£ç é¦–å…ˆæ£€æŸ¥è¾“å…¥æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œç„¶åæ£€æŸ¥è¾“å…¥æ•°ç»„å’Œè¾“å‡ºæ•°ç»„ä¸­çš„å…ƒç´ ï¼ˆå¼ é‡ï¼‰ä¸ªæ•°æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸æ»¡è¶³è¯¥æ¡ä»¶ï¼Œç¨‹åºè¿”å›å¹¶è®°å½•ç›¸å…³<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=233830208&content_type=Article&match_order=1&q=%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97&zhida_source=entity">é”™è¯¯æ—¥å¿—</a>ã€‚</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> batch_size = inputs.<span class="built_in">size</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; batch_size; ++i) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (output_data != <span class="literal">nullptr</span> &amp;&amp; !output_data-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (input_data-&gt;<span class="built_in">shapes</span>() != output_data-&gt;<span class="built_in">shapes</span>()) &#123;</span><br><span class="line">        <span class="built_in">LOG</span>(ERROR) &lt;&lt; <span class="string">&quot;The input and output tensor shapes of the relu &quot;</span></span><br><span class="line">                      <span class="string">&quot;layer do not match &quot;</span></span><br><span class="line">                   &lt;&lt; i &lt;&lt; <span class="string">&quot; th&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> InferStatus::kInferFailedInputOutSizeMatchError;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä»¥ä¸Šçš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯¹ä¸€ä¸ªæ‰¹æ¬¡ï¼ˆbatch sizeï¼‰çš„è¾“å…¥å¼ é‡æ•°æ®è¿›è¡Œäº†æ£€æŸ¥ã€‚æˆ‘ä»¬ä½¿ç”¨<code>(output_data != nullptr &amp;&amp; !output_data-&gt;empty())</code>æ¥æ£€æŸ¥è¾“å‡ºå¼ é‡æ˜¯å¦ä¸ºç©ºæŒ‡é’ˆï¼Œå¹¶ä¸”æ£€æŸ¥è¾“å‡ºå¼ é‡æ˜¯å¦å·²ç»åˆ†é…ç©ºé—´ä»¥å­˜å‚¨è®¡ç®—ç»“æœã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">uint32_t</span> j = <span class="number">0</span>; j &lt; input-&gt;<span class="built_in">size</span>(); ++j) &#123;</span><br><span class="line">      <span class="type">float</span> value = input-&gt;<span class="built_in">index</span>(j);</span><br><span class="line">      output-&gt;<span class="built_in">index</span>(j) = value &gt; <span class="number">0.f</span> ? value : <span class="number">0.f</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿›è¡Œå®Œä»¥ä¸Šä¿¡æ¯æ£€æŸ¥åï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª<code>for</code>å¾ªç¯é€ä¸ªå¤„ç†ä¸€ä¸ªå¤§å°ä¸º<code>batch_size</code>çš„è¾“å…¥å¼ é‡æ•°ç»„ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªå†…å±‚çš„<code>for</code>å¾ªç¯ä¸­ï¼Œæˆ‘ä»¬é€ä¸ªè¯»å–<code>input</code>çš„å€¼ï¼Œå¹¶åˆ¤æ–­å®ƒä¸0çš„å¤§å°å…³ç³»ã€‚å¦‚æœå¤§äº0ï¼Œåˆ™ä¿ç•™è¯¥å€¼ï¼›å¦åˆ™å°†å…¶ç½®ä¸º0.</p>
<h3 id="ReLUç®—å­çš„æ³¨å†Œ"><a href="#ReLUç®—å­çš„æ³¨å†Œ" class="headerlink" title="ReLUç®—å­çš„æ³¨å†Œ"></a>ReLUç®—å­çš„æ³¨å†Œ</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ParseParameterAttrStatus <span class="title">ReluLayer::GetInstance</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::shared_ptr&lt;RuntimeOperator&gt; &amp;op,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::shared_ptr&lt;Layer&gt; &amp;relu_layer)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">CHECK</span>(op != <span class="literal">nullptr</span>) &lt;&lt; <span class="string">&quot;Relu operator is nullptr&quot;</span>;</span><br><span class="line">  relu_layer = std::<span class="built_in">make_shared</span>&lt;ReluLayer&gt;();</span><br><span class="line">  <span class="keyword">return</span> ParseParameterAttrStatus::kParameterAttrParseSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LayerRegistererWrapper <span class="title">kReluGetInstance</span><span class="params">(<span class="string">&quot;nn.ReLU&quot;</span>, ReluLayer::GetInstance)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>ReluLayer::GetInstance</code>æ˜¯<code>ReLU</code>ç®—å­çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œè¯¥åˆå§‹åŒ–å‡½æ•°ç¬¦åˆä¹‹å‰<code>Creator</code>å‡½æ•°æŒ‡é’ˆçš„å‚æ•°ç±»å‹ã€å‚æ•°ä¸ªæ•°å’Œè¿”å›å€¼è¦æ±‚ã€‚è¯¥åˆå§‹åŒ–å‡½æ•°å¯¹ä¼ å…¥çš„<code>layer</code>è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶è¿”å›è¡¨ç¤ºæˆåŠŸçš„çŠ¶æ€ç ã€‚</p>
<p><code>Creator</code>å‡½æ•°æŒ‡é’ˆå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ParseParameterAttrStatus</span> <span class="params">(*Creator)</span></span></span><br><span class="line"><span class="function">      <span class="params">(<span class="type">const</span> std::shared_ptr&lt;RuntimeOperator&gt; &amp;op, std::shared_ptr&lt;Layer&gt; &amp;layer)</span></span>;</span><br></pre></td></tr></table></figure>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="æ‰“èµ" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><span class="icon iconify" data-icon="ri:hand-coin-line"></span></span><div id="reward-comment">I'm so cute. Please give me money.</div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>å®ç¿°</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="https://20020730.xyz/posts/e52053c3/" title="Lesson 5">https://20020730.xyz/posts/e52053c3/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é»˜è®¤é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> è®¸å¯åè®®ã€‚</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/posts/5d9c34a6/" rel="prev" title="Lesson 4"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">Lesson 4</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/posts/140cab1e/" rel="next" title="Introduction"><span class="post-nav-text">Introduction</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>è‹¥æ‚¨æƒ³åŠæ—¶å¾—åˆ°å›å¤æé†’ï¼Œå»ºè®®è·³è½¬ GitHub Issues è¯„è®ºã€‚</span><br><span>è‹¥æ²¡æœ‰æœ¬æ–‡ Issueï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Comment æ¨¡ç‰ˆæ–°å»ºã€‚</span><br></div><div class="toggle-comment-system" style="margin: 1rem auto"><a class="toggle-comment-btn hty-button hty-button--raised text-uppercase" data-target="#waline" onclick="showComment(this.dataset.target)">waline</a><style>.utterances {
  display: none;
}</style><a class="toggle-comment-btn hty-button hty-button--raised text-uppercase" data-target=".utterances" onclick="showComment(this.dataset.target)">utterances</a><script>function hideAllComment() {
  //- hide all
  document.querySelectorAll('.toggle-comment-btn').forEach((btn) => {
    const container = document.querySelector(btn.dataset.target);
    if (container) {
      container.style.display = "none";
    }
  });
}
function showComment(target) {
  hideAllComment();
  //- show target
  const targetContainer = document.querySelector(target);
  if (targetContainer) {
    targetContainer.style.display = "block";
  }
}
</script></div><div id="waline"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.css"><script>window.CONFIG.waline.config.path = "/posts/e52053c3/"</script><div class="js-Pjax"><script src="/js/comments/waline.js" type="module" defer></script></div><style>.utterances {
  max-width: 100%;
}</style><script src="https://utteranc.es/client.js" repo="Wanglihan954/disscussion" issue-term="pathname" label="comment" theme="github-light" crossorigin="anonymous" async></script></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2025 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> å®ç¿°</span></div><div class="powered"><span>ç”± <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> é©±åŠ¨ v8.1.1</span><span class="footer-separator">|</span><span>ä¸»é¢˜ - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div><div class="live-time"><span>æœ¬åšå®¢å·²èŒèŒå“’åœ°è¿è¡Œ</span><span id="display_live_time"></span><span class="moe-text">(â—'â—¡'â—)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2025-04-12T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = ` ${passDay} å¤© ${passHour} å°æ—¶ ${passMinute} åˆ† ${passSecond} ç§’`;
}
blog_live_time();
</script></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" target="_blank" rel="noopener" href="https://www.google.com/search?q=site:20020730.xyz" title="æœç´¢"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><!-- hexo injector body_end start --><script src="https://fastly.jsdelivr.net/npm/hexo-tag-common@0.2.0/js/index.js"></script><!-- hexo injector body_end end --></body></html>